<!DOCTYPE html>
<html>
<head>
    <title>Inspect System - Highball</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/nav.js"></script>
    <script src="/static/network-scan.js"></script>
    <style>
        .log-viewer {
            background-color: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 4px;
            height: 500px;
            overflow-y: auto;
            border: 1px solid #555;
            white-space: pre-wrap;
        }
        
        .log-controls {
            margin-bottom: 15px;
            padding: 15px;
            background-color: #3a3a3a;
            border-radius: 4px;
        }
        
        .live-indicator {
            color: #00ff00;
            font-weight: bold;
        }
        
        .live-indicator.disconnected {
            color: #ff0000;
        }
        
        .auto-scroll {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="navigation"></div>
        
        <h1>Inspect System</h1>
        
        <div class="config-section">
            <h3>Network Scanner</h3>
            <p>Scan your network for available rsync servers and their modules.</p>
            <div class="flex-row">
                <input type="text" id="networkRange" placeholder="192.168.1.0/24" class="w-150">
                <button id="scanNetwork" class="button button-warning">Scan Network for Rsync Servers</button>
            </div>
            <div id="scanResults" class="hidden mt-15">
                <h4>Found Rsync Servers:</h4>
                <div id="scanOutput" class="log-container" style="height: 200px;"></div>
            </div>
        </div>
        
        <div class="log-controls">
            <h3>Log Sources</h3>
            {{LOG_BUTTONS}}
            
            <div class="log-section">
                <label for="jobSelect">Job Logs:</label>
                <select id="jobSelect" onchange="viewJobLog()">
                    {{JOB_DROPDOWN}}
                </select>
            </div>
            
            <div class="log-section">
                <button id="toggleLive" class="button">Start Live Tail</button>
                <button id="clearLogs" class="button button-warning">Clear Display</button>
                <label class="auto-scroll">
                    <input type="checkbox" id="autoScroll" checked> Auto-scroll to bottom
                </label>
            </div>
        </div>
        
        <h2>{{LOG_NAME}}</h2>
        
        <div id="logContent" class="log-viewer">{{LOG_CONTENT}}</div>
    </div>

    <script>
        let eventSource = null;
        let isLive = false;
        const logContent = document.getElementById('logContent');
        const toggleButton = document.getElementById('toggleLive');
        const autoScrollCheckbox = document.getElementById('autoScroll');
        const logType = '{{LOG_TYPE}}';
        
        function scrollToBottom() {
            if (autoScrollCheckbox.checked) {
                logContent.scrollTop = logContent.scrollHeight;
            }
        }
        
        function viewJobLog() {
            const jobSelect = document.getElementById('jobSelect');
            const jobName = jobSelect.value;
            if (jobName) {
                window.location.href = `/logs?job=${encodeURIComponent(jobName)}`;
            }
        }
        
        function startLiveTail() {
            if (eventSource) {
                eventSource.close();
            }
            
            // Update button immediately to show connecting state
            isLive = true;
            toggleButton.textContent = 'Connecting...';
            toggleButton.className = 'button button-warning';
            toggleButton.disabled = true;
            
            // Handle job log streaming vs system log streaming
            let streamUrl;
            if (logType.startsWith('job:')) {
                const jobName = logType.substring(4); // Remove 'job:' prefix
                streamUrl = `/logs/stream?job=${encodeURIComponent(jobName)}`;
            } else {
                streamUrl = `/logs/stream?type=${logType}`;
            }
            eventSource = new EventSource(streamUrl);
            
            eventSource.onopen = function() {
                toggleButton.textContent = 'Stop Live Tail';
                toggleButton.className = 'button button-danger';
                toggleButton.disabled = false;
            };
            
            eventSource.onmessage = function(event) {
                logContent.textContent += event.data + '\n';
                scrollToBottom();
            };
            
            eventSource.onerror = function() {
                console.error('EventSource error occurred');
                stopLiveTail();
            };
        }
        
        function stopLiveTail() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            isLive = false;
            toggleButton.textContent = 'Start Live Tail';
            toggleButton.className = 'button button-success';
        }
        
        toggleButton.addEventListener('click', function() {
            if (isLive) {
                stopLiveTail();
            } else {
                startLiveTail();
            }
        });
        
        document.getElementById('clearLogs').addEventListener('click', function() {
            logContent.textContent = '';
        });
        
        // Auto-scroll to bottom on page load
        scrollToBottom();
        
        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>
