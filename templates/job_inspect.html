<!DOCTYPE html>
<html>
<head>
    <title>Inspect {{JOB_NAME}} - Highball</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="{{THEME_CSS_PATH}}">
    <script src="/static/nav.js"></script>
    <script src="/static/backup-browser.js"></script>
    <script src="/static/restore-core.js"></script>
    <script src="/static/restore-restic.js"></script>
</head>
<body>
    <div class="container">
        <div id="navigation"></div>
        
        <h1>Inspect Job: {{JOB_NAME}}</h1>
        <p class="job-type-info">Job Type: <strong>{{JOB_TYPE}}</strong></p>
        
        <!-- Job Status Section (moved from history page) -->
        <div class="section-container">
            <h2 class="section-header">Job Status</h2>
            
            <div class="form-group">
                <label>Last Run:</label>
                <div style="background-color: var(--bg-darker); padding: 12px; border-radius: 4px; font-family: monospace;">
                    {{LAST_RUN}}
                </div>
            </div>
            
            <div class="form-group">
                <label>Status:</label>
                <div style="background-color: var(--bg-darker); padding: 12px; border-radius: 4px; font-family: monospace;">
                    {{STATUS}}
                </div>
            </div>
            
            <div class="form-group">
                <label>Message:</label>
                <div style="background-color: var(--bg-darker); padding: 12px; border-radius: 4px; font-family: monospace; word-break: break-word;">
                    {{MESSAGE}}
                </div>
            </div>
        </div>
        
        <!-- Backup Browser Component -->
        <div class="section-container">
            <h2 class="section-header">Backup Browser</h2>
            
            {{JOB_TYPES_JS}}
            <!-- Hidden pre-selected dropdown for JavaScript compatibility -->
            <select id="backupJobSelect" onchange="loadBackupJob()" style="display: none;">
                {{BACKUP_JOB_DROPDOWN}}
            </select>
            
            <div id="browserContent" class="hidden backup-browser">
                <div id="repositoryInfo" class="help-text">
                    <!-- Repository/job information will be displayed here -->
                </div>
                
                <div id="snapshotSection" class="hidden">
                    <h3 id="snapshotSectionTitle">Select Snapshot/Archive:</h3>
                    <select id="snapshotSelect" onchange="loadSnapshotDetails()">
                        <option value="">Select a snapshot...</option>
                    </select>
                </div>
                
                <div id="snapshotDetails" class="hidden snapshot-details">
                    <h4 id="snapshotDetailsTitle">Details</h4>
                    <div id="snapshotInfo"></div>
                </div>
                
                <div id="fileTree" class="hidden file-tree">
                    <h3>File Browser</h3>
                    
                    <div id="selectionInfo" class="selection-info">
                        <span id="selectionCount">0 items selected</span>
                        <label>
                            <input type="checkbox" id="selectAllToggle" onchange="toggleSelectAll()">
                            Select All (Full Snapshot Restore)
                        </label>
                        <button onclick="clearSelection()" class="button button-warning">Clear Selection</button>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <div id="treeContainer" class="tree-container">
                            <!-- File tree will be populated here -->
                        </div>
                        <div id="selectionPane" class="selection-pane">
                            <div class="selection-header">Selected Items</div>
                            <div id="selectionList">
                                <div style="text-align: center; color: var(--text-muted); font-style: italic;">No items selected</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mode Toggle Switch -->
                    <div class="toggle-switch">
                        <span class="toggle-switch-label">Mode:</span>
                        <div class="toggle-container left" id="modeToggle" onclick="toggleMode()">
                            <div class="toggle-slider"></div>
                            <span class="toggle-option left">View</span>
                            <span class="toggle-option right">Restore</span>
                        </div>
                    </div>
                    
                    <!-- Restore Controls -->
                    <div id="restoreControls" class="restore-controls hidden">
                        <div class="restore-options">
                            <div>
                                <label>Restore Target:</label>
                                <select id="restoreTarget" onchange="handleRestoreTargetChange()">
                                    <option value="highball">Restore to Highball (/restore)</option>
                                    <option value="source">Restore to Source (original location)</option>
                                </select>
                            </div>
                            <div class="mt-15">
                                <label>
                                    <input type="checkbox" id="dryRunToggle" checked onchange="togglePasswordField()">
                                    Dry Run (safe preview - uncheck to perform actual restore)
                                </label>
                            </div>
                            <div id="overwriteWarning" class="mt-15 hidden">
                                <div class="alert alert-warning">
                                    <strong>Warning:</strong> <span id="overwriteWarningText">This restore will overwrite existing files.</span>
                                </div>
                            </div>
                            <div id="confirmationSection" class="mt-15 hidden">
                                <label for="overwriteConfirmation">Type "OVERWRITE" to confirm data replacement:</label>
                                <input type="text" id="overwriteConfirmation" class="w-full" placeholder="Type OVERWRITE to confirm">
                            </div>
                            <div class="mt-15">
                                <button id="startRestore" class="button button-success">Start Restore</button>
                                <div id="restoreValidationError" class="hidden" style="margin-top: 8px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="browserError" class="hidden error-message">
                <!-- Error messages will be displayed here -->
            </div>
            
        </div>
        
        <!-- Progress display inline in restore controls -->
        <div id="restoreProgress" class="restore-progress hidden">
            <div class="progress-section">
                <h4>Restore in Progress</h4>
                <div id="progressBar" class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
                <div id="progressText">Starting restore...</div>
            </div>
        </div>
        
        <!-- Job Logs -->
        <div class="section-container">
            <h2 class="section-header">Job Logs</h2>
            <div class="log-section">
                <button id="refreshLogs" class="button">Refresh</button>
                <button id="clearLogs" class="button button-warning">Clear Display</button>
            </div>
            
            <div id="logContent" class="log-viewer">{{JOB_LOG_CONTENT}}</div>
        </div>
    </div>

    <script>
        const logContent = document.getElementById('logContent');
        const refreshButton = document.getElementById('refreshLogs');
        const clearButton = document.getElementById('clearLogs');
        const restoreControls = document.getElementById('restoreControls');
        const selectAllToggle = document.getElementById('selectAllToggle');
        const selectionPane = document.getElementById('selectionPane');
        
        // Auto-load the backup job when page loads (since it's pre-selected)
        window.addEventListener('load', function() {
            loadBackupJob();
        });
        
        function refreshLogs() {
            // Only refresh the logs section, not the entire page
            const jobName = '{{JOB_NAME}}';
            const currentUrl = new URL(window.location);
            const refreshUrl = `/inspect?name=${encodeURIComponent(jobName)}`;
            
            // Fetch only the log content without reloading the page
            fetch(refreshUrl)
                .then(response => response.text())
                .then(html => {
                    // Parse the response to extract just the log content
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newLogContent = doc.getElementById('logContent');
                    
                    if (newLogContent) {
                        document.getElementById('logContent').innerHTML = newLogContent.innerHTML;
                    }
                })
                .catch(error => {
                    console.error('Error refreshing logs:', error);
                    // Fallback to full page reload if fetch fails
                    window.location.reload();
                });
        }
        
        function clearLogs() {
            logContent.textContent = '';
        }
        
        function toggleMode() {
            const modeToggle = document.getElementById('modeToggle');
            const restoreControls = document.getElementById('restoreControls');
            
            if (modeToggle.classList.contains('left')) {
                // Switch to Restore mode
                modeToggle.classList.remove('left');
                modeToggle.classList.add('right');
                restoreControls.classList.remove('hidden');
            } else {
                // Switch to View mode
                modeToggle.classList.remove('right');
                modeToggle.classList.add('left');
                restoreControls.classList.add('hidden');
            }
        }
        
        function toggleSelectAll() {
            const isChecked = selectAllToggle.checked;
            
            if (isChecked) {
                // Grey out selection pane when Select All is active
                selectionPane.style.opacity = '0.5';
                selectionPane.style.pointerEvents = 'none';
                // Clear any validation errors since we now have a selection
                clearRestoreValidationError();
            } else {
                // Re-enable selection pane
                selectionPane.style.opacity = '1';
                selectionPane.style.pointerEvents = 'auto';
            }
            
            // Check for overwrites when Select All changes
            window.checkOverwriteRisk();
        }
        
        function clearRestoreValidationError() {
            const errorDiv = document.getElementById('restoreValidationError');
            if (errorDiv) {
                errorDiv.classList.add('hidden');
            }
        }
        
        function togglePasswordField() {
            // This function name is kept for compatibility, but now it handles confirmation
            window.checkOverwriteRisk();
        }
        
        function handleRestoreTargetChange() {
            window.checkOverwriteRisk();
        }
        
        window.checkOverwriteRisk = async function checkOverwriteRisk() {
            const dryRunToggle = document.getElementById('dryRunToggle');
            const overwriteWarning = document.getElementById('overwriteWarning');
            const confirmationSection = document.getElementById('confirmationSection');
            
            // Hide confirmation elements by default
            overwriteWarning.classList.add('hidden');
            confirmationSection.classList.add('hidden');
            
            // ALWAYS check for overwrites - warn user regardless of dry run state
            const overwriteRisk = await window.checkForOverwrites();
            if (overwriteRisk.hasOverwrites) {
                // Always show warning with appropriate message
                const warningText = document.getElementById('overwriteWarningText');
                if (dryRunToggle.checked) {
                    warningText.textContent = 'This dry run is testing a restore that would overwrite existing files.';
                } else {
                    warningText.textContent = 'This restore will overwrite existing files.';
                }
                overwriteWarning.classList.remove('hidden');
                
                // Only require OVERWRITE confirmation for actual restores (not dry runs)
                if (!dryRunToggle.checked) {
                    confirmationSection.classList.remove('hidden');
                }
            }
        }
        
        window.checkForOverwrites = async function checkForOverwrites() {
            try {
                const jobName = '{{JOB_NAME}}';
                const selectAllChecked = document.getElementById('selectAllToggle').checked;
                const selectedPaths = window.BackupBrowser ? window.BackupBrowser.getSelection() : [];
                const currentSnapshot = document.getElementById('snapshotSelect').value;
                const restoreTarget = document.getElementById('restoreTarget').value;
                
                const formData = new FormData();
                formData.append('job_name', jobName);
                formData.append('snapshot_id', selectAllChecked ? 'latest' : currentSnapshot);
                formData.append('select_all', selectAllChecked ? 'on' : '');
                formData.append('restore_target', restoreTarget);
                
                // Add selected paths
                if (!selectAllChecked && selectedPaths.directories) {
                    selectedPaths.directories.forEach(path => formData.append('selected_paths', path));
                }
                if (!selectAllChecked && selectedPaths.files) {
                    selectedPaths.files.forEach(path => formData.append('selected_paths', path));
                }
                
                
                const response = await fetch('/check-restore-overwrites', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    return await response.json();
                } else {
                    console.error('Failed to check overwrites');
                    return { hasOverwrites: false };
                }
            } catch (error) {
                console.error('Error checking overwrites:', error);
                return { hasOverwrites: false };
            }
        }
        
        // Override the global selection update function (restore controls now controlled by toggle)
        window.originalUpdateSelectionDisplay = window.updateSelectionDisplay || function() {};
        window.updateSelectionDisplay = function() {
            window.originalUpdateSelectionDisplay();
            
            // Clear validation errors when items are selected
            const hasSelections = document.querySelectorAll('.tree-item input[type="checkbox"]:checked').length > 0;
            if (hasSelections) {
                clearRestoreValidationError();
            }
            
            // Check for overwrites whenever selection changes
            window.checkOverwriteRisk();
        };
        
        // Event listeners
        refreshButton.addEventListener('click', refreshLogs);
        clearButton.addEventListener('click', clearLogs);
    </script>
</body>
</html>