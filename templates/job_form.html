<!DOCTYPE html>
<html>
<head>
    <title>{{PAGE_TITLE}} - Highball</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="{{THEME_CSS_PATH}}">
    <script src="/static/nav.js"></script>
    <script src="/static/job-form-core.js"></script>
    <script src="/static/job-form-ssh.js"></script>
    <script src="/static/job-form-rsyncd.js"></script>
    <script src="/static/job-form-restic.js"></script>
    <script src="/static/job-form-source-paths.js"></script>
    <script src="/static/job-form-globals.js"></script>
</head>
<body>
    <div class="container">
        <div id="navigation"></div>
        
        <h1>{{FORM_TITLE}}</h1>
        
        <form method="post" action="/save-job" enctype="multipart/form-data">
            {{HIDDEN_FIELDS}}
            
            <!-- Job Identity Section -->
            <div class="form-section">
                <div class="section-content">
                    <h2 class="section-header">Job Identity & Source</h2>
                    <div class="form-group">
                        <label for="job_name">Job Name:</label>
                        <input type="text" id="job_name" name="job_name" required value="{{JOB_NAME}}" placeholder="e.g., documents, photos">
                    </div>
                    
                    {{INCLUDE:job_form_source.html}}
                </div>
            </div>
            
            <!-- Destination Section -->
            <div class="form-section">
                <div class="section-content">
                    <h2 class="section-header">Backup Destination</h2>
                    {{INCLUDE:job_form_dest_basic.html}}
                    
                    {{INCLUDE:job_form_dest_restic.html}}
                </div>
            </div>
            
            <!-- Source Options Section -->
            <div class="form-section">
                <div class="section-content">
                    <h2 class="section-header">Source Options</h2>
                    {{INCLUDE:job_form_source_options.html}}
                </div>
            </div>
            
            <!-- Notifications Section -->
            <div class="form-section">
                <div class="section-content">
                    <h2 class="section-header">Notifications</h2>
                    {{INCLUDE:job_form_notifications.html}}
                </div>
            </div>
            
            <!-- Actions Section -->
            <div class="form-section">
                <div class="section-content">
                    <h2 class="section-header">Actions</h2>
                    {{INCLUDE:job_form_actions.html}}
                    
                    {{ERROR_MESSAGE}}
                    
                    <div class="form-group">
                        <input type="submit" value="{{SUBMIT_BUTTON_TEXT}}" class="button button-success">
                        <a href="/" class="button">Cancel</a>
                    </div>
                </div>
            </div>
        </form>
        
        {{DELETE_FORM}}
    </div>
    
    <script>
        // Initialize form display based on current values
        document.addEventListener('DOMContentLoaded', function() {
            showSourceFields();
            showDestFields();
            showCronField();
            initializeSourcePaths();
            initializeNotificationProviders();
        });
        
        function showCronField() {
            const schedule = document.getElementById('schedule').value;
            const cronField = document.getElementById('cron_field');
            if (schedule === 'cron') {
                cronField.classList.remove('hidden');
            } else {
                cronField.classList.add('hidden');
            }
        }
        
        function initializeSourcePaths() {
            // Initialize source paths from server data for edit forms
            try {
                const sourcePathsJson = '{{SOURCE_PATHS_JSON}}';
                console.log('SOURCE_PATHS_JSON:', sourcePathsJson);
                
                if (sourcePathsJson && sourcePathsJson !== '') {
                    const sourcePaths = JSON.parse(sourcePathsJson);
                    console.log('Parsed source paths:', sourcePaths);
                    
                    const container = document.getElementById('source_paths_container');
                    if (!container) {
                        console.log('No source_paths_container found');
                        return;
                    }
                    
                    // Check if addPath function exists
                    if (typeof addPath !== 'function') {
                        console.log('addPath function not found');
                        return;
                    }
                    
                    // Get existing path entries (should include the default first path)
                    let pathEntries = container.querySelectorAll('.path-entry:not(#path_entry_template)');
                    
                    // Populate each path from the configuration
                    sourcePaths.forEach((pathData, index) => {
                        console.log('Processing path:', pathData);
                        
                        // If we need more path entries than we have, add them
                        if (index >= pathEntries.length) {
                            addPath();
                            pathEntries = container.querySelectorAll('.path-entry:not(#path_entry_template)');
                        }
                        
                        // Get the path entry for this index
                        const pathEntry = pathEntries[index];
                        
                        if (pathEntry) {
                            // Populate the fields
                            const pathInput = pathEntry.querySelector('input[name="source_paths[]"]');
                            const includesInput = pathEntry.querySelector('textarea[name="source_includes[]"]');
                            const excludesInput = pathEntry.querySelector('textarea[name="source_excludes[]"]');
                            
                            if (pathInput) pathInput.value = pathData.path || '';
                            if (includesInput) includesInput.value = pathData.includes ? pathData.includes.join('\n') : '';
                            if (excludesInput) excludesInput.value = pathData.excludes ? pathData.excludes.join('\n') : '';
                            
                            console.log('Populated path entry', index + 1, ':', pathData.path);
                        } else {
                            console.log('Could not find path entry', index + 1);
                        }
                    });
                } else {
                    console.log('No SOURCE_PATHS_JSON data');
                }
            } catch (error) {
                console.log('Could not initialize source paths:', error);
                // Fallback: ensure at least one path exists
                if (typeof addPath === 'function') {
                    const existingPaths = document.querySelectorAll('.path-entry:not(#path_entry_template)');
                    if (existingPaths.length === 0) {
                        addPath();
                    }
                }
            }
        }
    </script>
</body>
</html>