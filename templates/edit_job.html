<!DOCTYPE html>
<html>
<head>
    <title>Edit Backup Job - Backup Manager</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/nav.js"></script>
    <script src="/static/add-job.js"></script>
</head>
<body>
    <div class="container">
        <div id="navigation"></div>
        
        <h1>Edit Backup Job: {{JOB_NAME}}</h1>
        
        <form method="post" action="/save-job">
            <input type="hidden" name="original_job_name" value="{{JOB_NAME}}">
            
            <div class="form-group">
                <label for="job_name">Job Name:</label>
                <input type="text" id="job_name" name="job_name" required value="{{JOB_NAME}}">
            </div>
            
            <div class="form-group">
                <label for="source_type">Source Type:</label>
                <select id="source_type" name="source_type" required onchange="showSourceFields()">
                    <option value="">Select source...</option>
                    <option value="local">Local Path</option>
                    <option value="ssh">SSH Remote</option>
                </select>
                <script>
                    document.getElementById('source_type').value = '{{SOURCE_TYPE}}';
                </script>
            </div>
            
            <div id="source_local" style="display:none">
                <label for="source_local_path">Local Path:</label>
                <input type="text" name="source_local_path" value="{{SOURCE_LOCAL_PATH}}" placeholder="/var/lib/docker/volumes/data">
            </div>
            
            <div id="source_ssh" style="display:none">
                <label for="source_ssh_hostname">Hostname:</label>
                <input type="text" name="source_ssh_hostname" value="{{SOURCE_SSH_HOSTNAME}}" placeholder="server">
                
                <label for="source_ssh_username">Username:</label>
                <input type="text" name="source_ssh_username" value="{{SOURCE_SSH_USERNAME}}" placeholder="root">
                
                <label for="source_ssh_path">Path:</label>
                <input type="text" name="source_ssh_path" value="{{SOURCE_SSH_PATH}}" placeholder="/mnt/data">
                
                <div class="help-text">
                    <button type="button" onclick="validateSource()" class="button button-warning">Validate SSH Source</button>
                    <span id="source_validation_status"></span>
                    <div id="source_validation_details" style="display: none; background-color: #2a2a2a; padding: 10px; border-radius: 4px; margin-top: 10px; font-family: monospace; font-size: 12px;"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="dest_type">Destination Type:</label>
                <select id="dest_type" name="dest_type" required onchange="showDestFields()">
                    <option value="">Select destination...</option>
                    <option value="local">Local Path</option>
                    <option value="ssh">SSH Remote</option>
                    <option value="rsyncd">Rsync Daemon</option>
                </select>
                <script>
                    document.getElementById('dest_type').value = '{{DEST_TYPE}}';
                </script>
            </div>
            
            <div id="dest_local" style="display:none">
                <label for="dest_local_path">Local Destination Path (on source system):</label>
                <input type="text" name="dest_local_path" value="{{DEST_LOCAL_PATH}}" placeholder="/backups">
                <div class="help-text" style="background-color: #3a3a3a; padding: 10px; border-radius: 4px; margin-top: 5px;">
                    <strong>Important:</strong> "Local" means local to the SOURCE system, not this container.<br>
                    If source is SSH remote, destination will be created on that remote system.<br>
                    If source is local to this container, destination must be a mounted volume.
                </div>
            </div>
            
            <div id="dest_ssh" style="display:none">
                <label for="dest_ssh_hostname">Hostname:</label>
                <input type="text" name="dest_ssh_hostname" value="{{DEST_SSH_HOSTNAME}}" placeholder="backup-server">
                
                <label for="dest_ssh_username">Username:</label>
                <input type="text" name="dest_ssh_username" value="{{DEST_SSH_USERNAME}}" placeholder="backup">
                
                <label for="dest_ssh_path">Path:</label>
                <input type="text" name="dest_ssh_path" value="{{DEST_SSH_PATH}}" placeholder="/backups">
                
                <div class="help-text">
                    <button type="button" onclick="validateDestSSH()" class="button button-warning">Validate SSH Destination</button>
                    <span id="dest_ssh_validation_status"></span>
                    <div id="dest_ssh_validation_details" style="display: none; background-color: #2a2a2a; padding: 10px; border-radius: 4px; margin-top: 10px; font-family: monospace; font-size: 12px;"></div>
                </div>
            </div>
            
            <div id="dest_rsyncd" style="display:none">
                <label for="dest_rsyncd_hostname">Hostname:</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" name="dest_rsyncd_hostname" value="{{DEST_RSYNCD_HOSTNAME}}" placeholder="backup-server" style="flex: 1;">
                    <button type="button" onclick="discoverShares()" class="button button-warning">Discover Shares</button>
                </div>
                <span id="discover_status"></span>
                
                <div id="share_selection" style="margin-top: 15px;">
                    <label for="dest_rsyncd_share">Share:</label>
                    <select name="dest_rsyncd_share" id="dest_rsyncd_share">
                        <option value="">Select a share...</option>
                        <option value="{{DEST_RSYNCD_SHARE}}" selected>{{DEST_RSYNCD_SHARE}}</option>
                    </select>
                </div>
                
                <div class="help-text">
                    <div id="rsyncd_validation_details" style="display: none; background-color: #2a2a2a; padding: 10px; border-radius: 4px; margin-top: 10px; font-family: monospace; font-size: 12px;"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="includes">Include Patterns (optional):</label>
                <textarea name="includes" placeholder="**/*.jpg
documents/**">{{INCLUDES}}</textarea>
            </div>
            
            <div class="form-group">
                <label for="excludes">Exclude Patterns (optional):</label>
                <textarea name="excludes" placeholder="*.tmp
*.log
.git/**">{{EXCLUDES}}</textarea>
            </div>
            
            <div class="form-group">
                <label for="schedule">Schedule:</label>
                <select id="schedule" name="schedule" onchange="showCronField()">
                    <option value="manual">Manual Only</option>
                    <option value="hourly">Hourly</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                    <option value="cron">Custom Cron Pattern</option>
                </select>
                <script>
                    document.getElementById('schedule').value = '{{SCHEDULE_TYPE}}';
                </script>
            </div>
            
            <div id="cron_field" style="display:none; margin-top: 10px;">
                <label for="cron_pattern">Cron Pattern:</label>
                <input type="text" name="cron_pattern" value="{{CRON_PATTERN}}" placeholder="0 3 * * *" 
                       title="Format: minute hour day month weekday">
                <div class="help-text">
                    Examples: "0 3 * * *" (daily 3am), "0 */6 * * *" (every 6 hours), "0 3 * * 0" (weekly Sunday 3am)
                </div>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" name="enabled" value="true" {{ENABLED_CHECKED}}> Enabled
                </label>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" name="respect_conflicts" value="true" {{CONFLICTS_CHECKED}}> Wait for conflicting jobs (recommended)
                </label>
                <div class="help-text">
                    When enabled, this job will wait for other jobs using the same source or destination to finish before running.
                </div>
            </div>
            
            <input type="submit" value="Update Backup Job" class="button button-success">
            <a href="/" class="button" style="background-color: #6c757d;">Cancel</a>
        </form>
        
        <form method="post" action="/delete-job" style="margin-top: 20px;" onsubmit="return confirm('Are you sure you want to delete this backup job?')">
            <input type="hidden" name="job_name" value="{{JOB_NAME}}">
            <input type="submit" value="Delete Job" class="button button-danger">
        </form>
    </div>
    
    <script>
        // Initialize form display based on current values
        document.addEventListener('DOMContentLoaded', function() {
            showSourceFields();
            showDestFields();
            showCronField();
        });
        
        function showCronField() {
            const schedule = document.getElementById('schedule').value;
            const cronField = document.getElementById('cron_field');
            if (schedule === 'cron') {
                cronField.style.display = 'block';
            } else {
                cronField.style.display = 'none';
            }
        }
    </script>
</body>
</html>